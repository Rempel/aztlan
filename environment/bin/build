#!/bin/bash

# General variables
BIN_DIR=$( dirname $0 )

# Set build dir as environment root to run the docker-compose commands
ENV_ROOT=build

# Include helper scripts
. ${BIN_DIR}/shared/dotenv.sh
. ${BIN_DIR}/shared/aztlan_variables.sh
. ${BIN_DIR}/shared/docker_compose.sh
. ${BIN_DIR}/shared/docker_sync.sh

ENVIRONMENT_DIR=environment

dotenv ${ENVIRONMENT_DIR}/env/build.env

BUILD_FILES=(
	assets/fonts/
	assets/js/
	assets/stylus/
	assets/.babelrc
	assets/app.js
	assets/package-lock.json
	assets/package.json
	assets/webpack.config.js
	cli/composer.json
	cli/composer.lock
	environment/docker/
	environment/env/
	environment/docker-compose.yml
	environment/docker-compose.mac.yml
	environment/docker-sync.yml
	environment/profile
	inc/languages/
	inc/src/
	inc/autoload.php
	inc/composer.json
	inc/composer.lock
	public/index.php
	public/wp-config.php
	themes/
	wp-packages/languages
	wp-packages/mu-plugins
	wp-packages/private
	wp-packages/composer.json
	wp-packages/composer.lock
)

# Files necessary just to build
BUILD_CLEAN_FILES=(
	assets/fonts/
	assets/js/
	assets/node_modules/
	assets/stylus/
	assets/.babelrc
	assets/app.js
	assets/package-lock.json
	assets/package.json
	assets/webpack.config.js
	cli/composer.json
	cli/composer.lock
	inc/composer.json
	inc/composer.lock
	wp-packages/
)

SERVER_IMAGE=${REGISTRY_ENDPOINT}/${REPOSITORY_NAME}:server
SERVER_IMAGE_DIR=${ENVIRONMENT_DIR}/docker/nginx

FPM_IMAGE=${REGISTRY_ENDPOINT}/${REPOSITORY_NAME}:fpm
FPM_IMAGE_DIR=${ENVIRONMENT_DIR}/docker/wp-fpm

CLI_IMAGE=${REGISTRY_ENDPOINT}/${REPOSITORY_NAME}:cli
CLI_IMAGE_DIR=${ENVIRONMENT_DIR}/docker/wp-cli

set -euxo pipefail

cd ${PROJECT_ROOT_PATH}

# Make sure that build directory is empty and it exists
rm -rf ${ENV_ROOT_PATH}; mkdir -p ${ENV_ROOT_PATH}

# Copy file to execute the build process
# Use rsync to work with MacOS
rsync -aR ${BUILD_FILES[@]} ${ENV_ROOT_PATH}/

# Use Docker Sync to speed up the build process on Mac
docker_sync start

# Install PHP packages
docker_compose run --rm cli-composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader
docker_compose run --rm inc-composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader
docker_compose run --rm wp-composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader

# Unpack private plugins and themes in public directory
PACKAGES_TYPE=(plugins themes)
for TYPE in "${PACKAGES_TYPE[@]}"; do
  DEST_DIR=${ENV_ROOT_PATH}/public/packages/${TYPE}
  mkdir -p ${DEST_DIR}
  find ${ENV_ROOT_PATH}/wp-packages/private/${TYPE} -name *.zip | xargs unzip -od ${DEST_DIR}
done

# Copy mu-plugins files to public directory
DEST_DIR=${ENV_ROOT_PATH}/public/packages/mu-plugins
mkdir -p ${DEST_DIR}
rsync -a ${ENV_ROOT_PATH}/wp-packages/mu-plugins/* ${DEST_DIR}

# Install Node packages and build assets to distribution
docker_compose run --rm assets-node npm ci
docker_compose run --rm assets-node npm run build

# Cleanup not necessary files after the build
cd ${ENV_ROOT_PATH}
rm -rf ${BUILD_CLEAN_FILES[@]}
cd ${PROJECT_ROOT_PATH}

docker_compose run --rm cli-composer find /app -type d -maxdepth 1
exit

# Wait build process generated files to be synced with host
docker_sync_wait assets/dist
docker_sync_wait cli/vendor
docker_sync_wait inc/vendor
docker_sync_wait public/packages
docker_sync_wait public/wp

# Build WP-CLI image
tar -zcf ${CLI_IMAGE_DIR}/dist.tar.gz -C ${ENV_ROOT_PATH} cli inc public themes
docker build --target distribution -t ${CLI_IMAGE} -t ${CLI_IMAGE}-${VERSION} ${CLI_IMAGE_DIR}
docker push ${CLI_IMAGE}
docker push ${CLI_IMAGE}-${VERSION}

# Build server image
tar -zcf ${SERVER_IMAGE_DIR}/dist.tar.gz -C ${ENV_ROOT_PATH} assets public themes
docker build -t ${SERVER_IMAGE} -t ${SERVER_IMAGE}-${VERSION} ${SERVER_IMAGE_DIR}
docker push ${SERVER_IMAGE}
docker push ${SERVER_IMAGE}-${VERSION}

# Build WordPress PHP-FPM image
tar -zcf ${FPM_IMAGE_DIR}/dist.tar.gz -C ${ENV_ROOT_PATH} inc public themes
docker build -t ${FPM_IMAGE} -t ${FPM_IMAGE}-${VERSION} ${FPM_IMAGE_DIR}
docker push ${FPM_IMAGE}
docker push ${FPM_IMAGE}-${VERSION}

# Stop Docker Sync because it isn't more necessary
docker_sync stop
